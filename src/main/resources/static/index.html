<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ã‚²ãƒ¼ãƒ åˆ¶ä½œ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ„ãƒªãƒ¼</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        .controls {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .task-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border-left: 5px solid #4CAF50;
            /* è¦ªã‚¿ã‚¹ã‚¯ã®å·¦å´ã¯ç·‘è‰² */
        }

        .child-task {
            border-left: 5px solid #2196F3;
            /* å­ã‚¿ã‚¹ã‚¯ã®å·¦å´ã¯é’è‰² */
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <h1>ğŸ® ã‚²ãƒ¼ãƒ åˆ¶ä½œ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒœãƒ¼ãƒ‰ï¼ˆãƒ„ãƒªãƒ¼æ§‹é€ ï¼‰</h1>

    <div class="controls">
        <input type="text" id="taskTitle" placeholder="ã‚¿ã‚¹ã‚¯åï¼ˆä¾‹ï¼šUIãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰" style="width: 200px;">
        <input type="number" id="taskHours" placeholder="å·¥æ•°" style="width: 70px;">

        <select id="parentTaskSelect">
            <option value="">(è¦ªã‚¿ã‚¹ã‚¯ãªã— - å¤§é …ç›®)</option>
        </select>

        <button onclick="addTask()">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
    </div>

    <div id="taskList"></div>

    <script>
        // â‘  ç”»é¢ãŒé–‹ã„ãŸæ™‚ã«ã€APIã‹ã‚‰ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
        async function fetchTasks() {
            const response = await fetch('/api/tasks');
            const tasks = await response.json();

            // --- â˜…ã“ã“ã‹ã‚‰ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’ä½œã‚‹é­”æ³•ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
            const taskMap = {};
            const roots = []; // è¦ªãŒã„ãªã„ä¸€ç•ªä¸Šã®ã‚¿ã‚¹ã‚¯ã‚’å…¥ã‚Œã‚‹ç®±

            // 1. å…¨ã‚¿ã‚¹ã‚¯ã«ã€Œå­ã‚¿ã‚¹ã‚¯ã‚’å…¥ã‚Œã‚‹ç©ºã®ç®±ï¼ˆchildrenï¼‰ã€ã‚’ç”¨æ„ã™ã‚‹
            tasks.forEach(task => {
                task.children = [];
                taskMap[task.id] = task;
            });

            // 2. è¦ªãŒã„ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã€è¦ªã®ã€Œchildrenã€ç®±ã®ä¸­ã«å…¥ã‚Œã‚‹
            tasks.forEach(task => {
                if (task.parentTaskId) {
                    if (taskMap[task.parentTaskId]) {
                        taskMap[task.parentTaskId].children.push(task);
                    }
                } else {
                    roots.push(task); // è¦ªãŒã„ãªã„ã‚¿ã‚¹ã‚¯ã¯ãƒ«ãƒ¼ãƒˆï¼ˆä¸€ç•ªä¸Šï¼‰
                }
            });
            // ------------------------------------------------

            // ç”»é¢ã®æç”»ã‚’ãƒªã‚»ãƒƒãƒˆ
            const listDiv = document.getElementById('taskList');
            listDiv.innerHTML = '';

            // ãƒ„ãƒªãƒ¼ã‚’æç”»ã™ã‚‹ï¼ˆå†å¸°é–¢æ•°ã‚’ä½¿ã£ã¦å­ã®å­ã¾ã§æç”»ï¼‰
            roots.forEach(rootTask => {
                listDiv.appendChild(createTaskElement(rootTask, 0));
            });

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’æœ€æ–°ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã§æ›´æ–°ã™ã‚‹
            updateParentSelect(tasks);
        }

        // â˜…è¿½åŠ ï¼šã‚¿ã‚¹ã‚¯ã®ã‚«ãƒ¼ãƒ‰ï¼ˆHTMLï¼‰ã‚’ä½œã‚Šå‡ºã™é–¢æ•°
        function createTaskElement(task, depth) {
            const div = document.createElement('div');
            div.className = depth === 0 ? 'task-card' : 'task-card child-task';
            // éšå±¤ï¼ˆdepthï¼‰ãŒæ·±ããªã‚‹ã”ã¨ã«ã€å·¦å´ã«20pxãšã¤ä½™ç™½ã‚’é–‹ã‘ã‚‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼‰
            div.style.marginLeft = `${depth * 20}px`;

            div.innerHTML = `
                <strong>${task.title}</strong>
                <span style="color: gray; font-size: 0.9em;"> (ID:${task.id} / å·¥æ•°: ${task.estimatedHours}h / çŠ¶æ…‹: ${task.status})</span>
                <button onclick="deleteTask(${task.id})" style="margin-left: 10px; color: red;">å‰Šé™¤</button>
            `;

            // ã‚‚ã—å­ã‚¿ã‚¹ã‚¯ã‚’æŒã£ã¦ã„ãŸã‚‰ã€è‡ªåˆ†ã®ä¸­ã«ã•ã‚‰ã«å­ã‚¿ã‚¹ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹
            if (task.children && task.children.length > 0) {
                task.children.forEach(child => {
                    div.appendChild(createTaskElement(child, depth + 1));
                });
            }
            return div;
        }

        // â˜…è¿½åŠ ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateParentSelect(tasks) {
            const select = document.getElementById('parentTaskSelect');
            select.innerHTML = '<option value="">(è¦ªã‚¿ã‚¹ã‚¯ãªã— - å¤§é …ç›®)</option>';
            tasks.forEach(task => {
                select.innerHTML += `<option value="${task.id}">${task.title}</option>`;
            });
        }

        // â‘¡ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«ã€APIã¸æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ã™ã‚‹
        async function addTask() {
            const titleInput = document.getElementById('taskTitle').value;
            const hoursInput = document.getElementById('taskHours').value;
            const parentIdInput = document.getElementById('parentTaskSelect').value;

            if (!titleInput) return alert("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const newTask = {
                title: titleInput,
                description: "",
                assignee: "æœªå®š",
                status: "TODO",
                estimatedHours: hoursInput ? parseInt(hoursInput) : 0,
                parentTaskId: parentIdInput ? parseInt(parentIdInput) : null // â˜…è¿½åŠ ï¼šè¦ªã‚¿ã‚¹ã‚¯ã®IDã‚’ä¸€ç·’ã«é€ã‚‹
            };

            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTask)
            });

            // é€ä¿¡ãŒçµ‚ã‚ã£ãŸã‚‰ã€å…¥åŠ›æ¬„ã‚’ç©ºã«ã—ã¦ä¸€è¦§ã‚’å†å–å¾—
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskHours').value = '';
            fetchTasks();
        }
        // â‘¢ ã€è¿½åŠ ã€‘å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«ã€APIã¸å‰Šé™¤ä¾é ¼ï¼ˆDELETEï¼‰ã‚’é€ä¿¡ã™ã‚‹
        async function deleteTask(id) {
            // é–“é•ãˆã¦æŠ¼ã—ãŸæ™‚ã®ãŸã‚ã«ã€ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
            if (!confirm("æœ¬å½“ã«ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰ä½•ã‚‚ã—ãªã„
            }

            // DELETEãƒ¡ã‚½ãƒƒãƒ‰ã§APIã‚’å‘¼ã³å‡ºã™
            await fetch('/api/tasks/' + id, {
                method: 'DELETE'
            });

            // å‰Šé™¤ãŒçµ‚ã‚ã£ãŸã‚‰ã€ä¸€è¦§ã‚’å†å–å¾—ã—ã¦ç”»é¢ã‚’æ›´æ–°
            fetchTasks();
        }
        // ç”»é¢ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰æœ€åˆã«å®Ÿè¡Œã™ã‚‹
        fetchTasks();
    </script>
</body>

</html>