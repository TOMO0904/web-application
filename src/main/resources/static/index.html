<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ã‚²ãƒ¼ãƒ åˆ¶ä½œ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ„ãƒªãƒ¼</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        .controls {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .member-controls {
            border-left: 5px solid #FF9800;
        }

        .task-controls {
            border-left: 5px solid #4CAF50;
        }

        .task-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border-left: 5px solid #4CAF50;
        }

        .child-task {
            border-left: 5px solid #2196F3;
            margin-top: 5px;
        }

        /* æ‹…å½“è€…ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹ */
        .assignee-select {
            background-color: #e3f2fd;
            padding: 2px;
            border: 1px solid #90caf9;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>ğŸ® ã‚²ãƒ¼ãƒ åˆ¶ä½œ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒœãƒ¼ãƒ‰</h1>

    <div class="controls member-controls">
        <h3 style="margin-top: 0;">ğŸ‘¤ ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</h3>
        <input type="text" id="memberName" placeholder="ãƒ¡ãƒ³ãƒãƒ¼å">
        <button onclick="addMember()">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </button>
    </div>

    <div class="controls task-controls">
        <h3 style="margin-top: 0;">ğŸ“ ã‚¿ã‚¹ã‚¯ç™»éŒ²</h3>
        <input type="text" id="taskTitle" placeholder="ã‚¿ã‚¹ã‚¯å" style="width: 200px;">
        <input type="number" id="taskHours" placeholder="å·¥æ•°" min="0" style="width: 70px;">
        <select id="parentTaskSelect">
            <option value="">(è¦ªã‚¿ã‚¹ã‚¯ãªã— - å¤§é …ç›®)</option>
        </select>

        <button onclick="addTask()">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
    </div>

    <h3 style="margin-top: 20px; color: #333;">ğŸƒ é€²è¡Œä¸­ãƒ»æœªå®šã®ã‚¿ã‚¹ã‚¯ï¼ˆãƒ„ãƒªãƒ¼ï¼‰</h3>
    <div id="taskList"></div>

    <h3 style="margin-top: 40px; color: #666;">âœ… å®Œäº†æ¸ˆã¿ã®ã‚¿ã‚¹ã‚¯</h3>
    <div id="completedTaskList"></div>

    <script>
        let globalMembers = [];

        async function fetchMembers() {
            try {
                const response = await fetch('/api/members');
                globalMembers = await response.json();
            } catch (e) { console.warn("ãƒ¡ãƒ³ãƒãƒ¼å–å¾—å¤±æ•—", e); }
        }

        async function addMember() {
            const nameInput = document.getElementById('memberName').value;
            if (!nameInput) return alert("ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            await fetch('/api/members', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: nameInput })
            });
            document.getElementById('memberName').value = '';
            await fetchMembers();
            fetchTasks();
        }

        async function fetchTasks() {
            try {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();

                const taskMap = {};
                const roots = [];
                const completedTasks = [];

                tasks.forEach(task => {
                    if (task.status === 'DONE') {
                        completedTasks.push(task);
                    } else {
                        task.children = [];
                        taskMap[task.id] = task;
                    }
                });

                tasks.forEach(task => {
                    if (task.status !== 'DONE') {
                        if (task.parentTaskId && taskMap[task.parentTaskId]) {
                            taskMap[task.parentTaskId].children.push(task);
                        } else {
                            roots.push(task);
                        }
                    }
                });

                const listDiv = document.getElementById('taskList');
                listDiv.innerHTML = '';
                roots.forEach(rootTask => {
                    listDiv.appendChild(createTaskElement(rootTask, 0, []));
                });

                const completedDiv = document.getElementById('completedTaskList');
                completedDiv.innerHTML = '';
                completedTasks.forEach(task => {
                    completedDiv.appendChild(createCompletedTaskElement(task));
                });

                updateParentSelect(tasks.filter(t => t.status !== 'DONE'));
            } catch (e) { console.warn("ã‚¿ã‚¹ã‚¯å–å¾—å¤±æ•—", e); }
        }
        // â˜…è¿½åŠ ï¼šå­ã‚¿ã‚¹ã‚¯ã®å·¥æ•°ã‚’å†å¸°çš„ã«è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateTotalEffort(taskNode) {
            // å­ãŒãªã‘ã‚Œã°ã€è‡ªåˆ†è‡ªèº«ã®å·¥æ•°ã‚’è¿”ã™
            if (!taskNode.children || taskNode.children.length === 0) {
                return taskNode.estimatedHours ? parseInt(taskNode.estimatedHours) : 0;
            }
            // å­ãŒã„ã‚Œã°ã€ã™ã¹ã¦ã®å­ã®å·¥æ•°ã‚’è¶³ã—åˆã‚ã›ã‚‹
            let total = 0;
            taskNode.children.forEach(child => {
                total += calculateTotalEffort(child);
            });
            return total;
        }
        // â˜…è¿½åŠ ï¼šå­ã‚¿ã‚¹ã‚¯ã®å·¥æ•°ã‚’å†å¸°çš„ã«è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆcreateTaskElementã®ã™ãä¸Šã«ç½®ãã¾ã™ï¼‰
        function calculateTotalEffort(taskNode) {
            // å­ãŒãªã‘ã‚Œã°ã€è‡ªåˆ†è‡ªèº«ã®å·¥æ•°ã‚’è¿”ã™
            if (!taskNode.children || taskNode.children.length === 0) {
                return taskNode.estimatedHours ? parseInt(taskNode.estimatedHours) : 0;
            }
            // å­ãŒã„ã‚Œã°ã€ã™ã¹ã¦ã®å­ã®å·¥æ•°ã‚’è¶³ã—åˆã‚ã›ã‚‹
            let total = 0;
            taskNode.children.forEach(child => {
                total += calculateTotalEffort(child);
            });
            return total;
        }

        function createTaskElement(task, depth, rootAssignees) {
            const div = document.createElement('div');
            div.className = depth === 0 ? 'task-card' : 'task-card child-task';
            div.style.marginLeft = `${depth * 20}px`;

            let currentAssignees = task.assignee && task.assignee !== "æœªå®š" ? task.assignee.split(',') : [];

            if (depth === 0) {
                rootAssignees = currentAssignees;
            }

            // --- HTMLã®çµ„ã¿ç«‹ã¦é–‹å§‹ ---
            let html = `<strong>${task.title}</strong><br>`;

            // ã€1. æ‹…å½“è€…ã®UIï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ç¶­æŒï¼‰ã€‘
            if (depth === 0) {
                html += `<span style="font-size: 0.85em; color: #333; background: #fff3e0; padding: 2px 5px; border-radius: 3px;">ğŸ‘¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼: `;
                if (currentAssignees.length === 0) {
                    html += `ãªã—`;
                } else {
                    currentAssignees.forEach(member => {
                        html += `ğŸ‘¤${member} <button onclick="removeRootAssignee(${task.id}, '${member}', '${task.assignee}', '${task.title}', ${task.estimatedHours}, ${task.parentTaskId || null}, '${task.status}')" style="font-size:0.7em; cursor:pointer; background:none; border:none; color:red;">âœ–</button> `;
                    });
                }
                html += `</span>`;

                let addOptions = `<option value="">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </option>`;
                globalMembers.forEach(m => {
                    if (!currentAssignees.includes(m.name)) {
                        addOptions += `<option value="${m.name}">${m.name}</option>`;
                    }
                });
                html += `<select onchange="addRootAssignee(${task.id}, this.value, '${task.assignee}', '${task.title}', ${task.estimatedHours}, ${task.parentTaskId || null}, '${task.status}')" style="margin-left: 10px; font-size: 0.8em;">${addOptions}</select>`;

            } else {
                let assigneeOptions = `<option value="æœªå®š">ğŸ‘¤ æœªå®š (å–ã‚‹)</option>`;
                rootAssignees.forEach(member => {
                    const isSelected = (task.assignee === member) ? 'selected' : '';
                    assigneeOptions += `<option value="${member}" ${isSelected}>ğŸ‘¤ ${member}</option>`;
                });

                // â˜…å¤‰æ›´ï¼šè¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«èª°ã‚‚ã„ãªã„å ´åˆã¯ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã€Œdisabledã€ã‚’ä»˜ã‘ã¦ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼ˆæ“ä½œä¸å¯ï¼‰ã«ã™ã‚‹
                const disabledAttr = rootAssignees.length === 0
                    ? 'disabled style="background-color: #f5f5f5; color: #aaa; border-color: #ddd; cursor: not-allowed;" title="å…ˆã«è¦ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"'
                    : '';

                html += `<select class="assignee-select" ${disabledAttr} onchange="updateTaskAssignee(${task.id}, this.value, '${task.title}', ${task.estimatedHours}, ${task.parentTaskId || null}, '${task.status}')">${assigneeOptions}</select>`;
            }
            // ã€2. å·¥æ•°ã¨ãƒœã‚¿ãƒ³ã®UIã€‘
            const hasChildren = task.children && task.children.length > 0;

            // â˜…å¤‰æ›´ï¼šè¿½åŠ ã—ãŸé–¢æ•°(calculateTotalEffort)ã‚’å‘¼ã³å‡ºã—ã¦ã€ä¸‹å±¤ã®å·¥æ•°ã‚’å…¨éƒ¨è¶³ã—åˆã‚ã›ã‚‹ï¼
            const displayHours = hasChildren ? calculateTotalEffort(task) : task.estimatedHours;

            const isDisabled = hasChildren ? 'disabled' : '';
            const inputStyle = hasChildren ? 'background-color: #e9ecef; color: #666; cursor: not-allowed;' : '';

            html += `
                <span style="color: gray; font-size: 0.9em; margin-left: 10px;">(å·¥æ•°: 
                    <input type="number" 
                           value="${displayHours}" 
                           ${isDisabled} min="0"
                           style="width: 50px; padding: 2px; font-weight: bold; border: 1px solid #ccc; border-radius: 4px; ${inputStyle}" 
                           onchange="updateTaskHours(${task.id}, this.value, '${task.title}', ${task.parentTaskId || null}, '${task.status}', '${task.assignee}')"> h)
                </span>
                
                <button onclick="updateTaskStatus(${task.id}, 'DONE', '${task.title}', ${task.estimatedHours}, ${task.parentTaskId || null}, '${task.assignee}')" style="margin-left: 15px; color: white; background-color: #4CAF50; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">âœ… å®Œäº†</button>
                <button onclick="deleteTask(${task.id})" style="margin-left: 10px; color: red;">å‰Šé™¤</button>
            `;

            div.innerHTML = html;

            if (task.children && task.children.length > 0) {
                task.children.forEach(child => {
                    div.appendChild(createTaskElement(child, depth + 1, rootAssignees));
                });
            }
            return div;
        }

        function createCompletedTaskElement(task) {
            const div = document.createElement('div');
            div.className = 'task-card';
            div.style.borderLeft = '5px solid #9e9e9e';
            div.style.backgroundColor = '#f5f5f5';
            div.innerHTML = `
                <strong style="text-decoration: line-through; color: #757575;">${task.title}</strong>
                <span style="color: gray; font-size: 0.9em; margin-left: 10px;">æ‹…å½“: ğŸ‘¤ ${task.assignee} (å·¥æ•°: ${task.estimatedHours}h)</span>
                <button onclick="updateTaskStatus(${task.id}, 'TODO', '${task.title}', ${task.estimatedHours}, ${task.parentTaskId || null}, '${task.assignee}')" style="margin-left: 15px; font-size: 0.8em;">â†©ï¸ æœªå®Œäº†ã«æˆ»ã™</button>
                <button onclick="deleteTask(${task.id})" style="margin-left: 10px; color: red;">å‰Šé™¤</button>
            `;
            return div;
        }

        // --- APIç³»é–¢æ•° ---
        async function addRootAssignee(id, newMember, currentAssigneesStr, title, hours, parentId, status) {
            if (!newMember) return;
            let assignees = currentAssigneesStr && currentAssigneesStr !== "æœªå®š" ? currentAssigneesStr.split(',') : [];
            if (!assignees.includes(newMember)) assignees.push(newMember);
            await updateTaskApi(id, title, assignees.join(','), status, hours, parentId);
        }

        async function removeRootAssignee(id, memberToRemove, currentAssigneesStr, title, hours, parentId, status) {
            let assignees = currentAssigneesStr && currentAssigneesStr !== "æœªå®š" ? currentAssigneesStr.split(',') : [];
            assignees = assignees.filter(m => m !== memberToRemove);
            let newAssigneeStr = assignees.length > 0 ? assignees.join(',') : 'æœªå®š';
            await updateTaskApi(id, title, newAssigneeStr, status, hours, parentId);
        }

        function updateParentSelect(tasks) {
            const select = document.getElementById('parentTaskSelect');
            select.innerHTML = '<option value="">(è¦ªã‚¿ã‚¹ã‚¯ãªã— - å¤§é …ç›®)</option>';
            tasks.forEach(task => { select.innerHTML += `<option value="${task.id}">${task.title}</option>`; });
        }

        async function addTask() {
            const titleInput = document.getElementById('taskTitle').value;
            const hoursInput = document.getElementById('taskHours').value;
            const parentIdInput = document.getElementById('parentTaskSelect').value;
            if (!titleInput) return alert("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            await fetch('/api/tasks', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: titleInput, description: "", assignee: "æœªå®š", status: "TODO", estimatedHours: hoursInput ? parseInt(hoursInput) : 0, parentTaskId: parentIdInput ? parseInt(parentIdInput) : null })
            });
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskHours').value = '';
            fetchTasks();
        }

        async function updateTaskAssignee(id, newAssignee, title, hours, parentId, status) { await updateTaskApi(id, title, newAssignee, status, hours, parentId); }
        async function updateTaskHours(id, newHours, title, parentId, status, assignee) { await updateTaskApi(id, title, assignee, status, newHours ? parseInt(newHours) : 0, parentId); }
        async function updateTaskStatus(id, newStatus, title, hours, parentId, assignee) { await updateTaskApi(id, title, assignee, newStatus, hours, parentId); }

        async function updateTaskApi(id, title, assignee, status, hours, parentId) {
            await fetch('/api/tasks/' + id, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title, description: "", assignee: assignee, status: status, estimatedHours: hours, parentTaskId: parentId })
            });
            fetchTasks();
        }

        async function deleteTask(id) {
            if (!confirm("æœ¬å½“ã«ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await fetch('/api/tasks/' + id, { method: 'DELETE' });
            fetchTasks();
        }

        async function init() {
            await fetchMembers();
            await fetchTasks();
        }
        init(); 
    </script>
</body>

</html>